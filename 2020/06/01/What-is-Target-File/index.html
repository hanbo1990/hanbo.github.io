<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hanbo1990.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"MNU53WUW1V","apiKey":"9683ae70dc183856fd122d6ff742e808","indexName":"bo_blog","hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="The target file is generated after compilation of the source code. What do we store in them?">
<meta property="og:type" content="article">
<meta property="og:title" content="What is a Target File">
<meta property="og:url" content="https://hanbo1990.com/2020/06/01/What-is-Target-File/index.html">
<meta property="og:site_name" content="tech memory">
<meta property="og:description" content="The target file is generated after compilation of the source code. What do we store in them?">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-06-01T08:58:50.000Z">
<meta property="article:modified_time" content="2020-10-16T07:50:40.375Z">
<meta property="article:author" content="Bo Han">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://hanbo1990.com/2020/06/01/What-is-Target-File/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>What is a Target File | tech memory</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">tech memory</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-c/c++">

    <a href="/categories/ccpp" rel="section"><i class="fa fa-code fa-fw"></i>C/C++</a>

  </li>
        <li class="menu-item menu-item-linux">

    <a href="/categories/linux/" rel="section"><i class="fab fa-linux fa-fw"></i>Linux</a>

  </li>
        <li class="menu-item menu-item-other">

    <a href="/categories/other" rel="section"><i class="fab fa-mix fa-fw"></i>Other</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://hanbo1990.com/2020/06/01/What-is-Target-File/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Bo Han">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tech memory">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          What is a Target File
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-01 10:58:50" itemprop="dateCreated datePublished" datetime="2020-06-01T10:58:50+02:00">2020-06-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-16 09:50:40" itemprop="dateModified" datetime="2020-10-16T09:50:40+02:00">2020-10-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ccpp/" itemprop="url" rel="index"><span itemprop="name">ccpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>The target file is generated after compilation of the source code. What do we store in them?</strong></p>
<a id="more"></a>

<p>The popular format of the executable under modern OS is mainly PE (Portable Executable in windows) or <code>ELF (Executable Linkable Format in Linux)</code>. Target files are generated after compile of the source code before the link process (<code>.obj</code> in Windows and <code>.o</code> in Linux). They are almost the same in file format as executable, so we can treat them as the same file type - the <a href="https://eklitzke.org/position-independent-executables" target="_blank" rel="noopener">ELF file type</a>.</p>
<table>
<thead>
<tr>
<th>ELF Type</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody><tr>
<td>Relocatable File</td>
<td>Contain code and data, can be linked to generate the executable or shared target, static library is part of this.</td>
<td>.o</td>
</tr>
<tr>
<td>Executable File</td>
<td>Contain executable.</td>
<td>c program with main()</td>
</tr>
<tr>
<td>Shared Object File</td>
<td>Contain code and data, can be used to link together with other relocatable files to generate a new target file.</td>
<td>.so</td>
</tr>
<tr>
<td>Core Dump File</td>
<td>When process quit under exception, the system can store some downtime data into this file.</td>
<td>Core dump</td>
</tr>
</tbody></table>
<p>We can use <code>file</code> command to see the types of different target files.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ file test.so</span><br><span class="line">test.so: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, BuildID[sha1]=6b99598966834ca67f0d9fee4d6c21b8084ae7a5, with debug_info, not stripped</span><br></pre></td></tr></table></figure>

<h2 id="Study-with-test-o"><a href="#Study-with-test-o" class="headerlink" title="Study with test.o"></a>Study with test.o</h2><p>Assume we have below code in test.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test.c</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">printf</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* format, ...)</span></span>;</span><br><span class="line"><span class="keyword">int</span> global_init_var = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> global_uninit_var;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func1</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> static_init_var = <span class="number">85</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> static_uninit_var;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> b;</span><br><span class="line">    </span><br><span class="line">    func1(static_init_var + static_uninit_var + a + b);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Let’s compile this file: using <code>gcc -c test.c</code> to get test.o. We can check the content and structure of this .o file using <code>objdump -h test.o</code>. The command will list all sections’ basic information in the ELF header.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">test.o:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name          Size      VMA               LMA               File off  Algn</span><br><span class="line">  0 .text         00000057  0000000000000000  0000000000000000  00000040  2**0</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE</span><br><span class="line">  1 .data         00000008  0000000000000000  0000000000000000  00000098  2**2</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line">  2 .bss          00000004  0000000000000000  0000000000000000  000000a0  2**2</span><br><span class="line">                  ALLOC</span><br><span class="line">  3 .rodata       00000004  0000000000000000  0000000000000000  000000a0  2**0</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, READONLY, DATA</span><br><span class="line">  4 .comment      0000002a  0000000000000000  0000000000000000  000000a4  2**0</span><br><span class="line">                  CONTENTS, READONLY</span><br><span class="line">  5 .note.GNU-stack 00000000  0000000000000000  0000000000000000  000000ce  2**0</span><br><span class="line">                  CONTENTS, READONLY</span><br><span class="line">  6 .eh_frame     00000058  0000000000000000  0000000000000000  000000d0  2**3</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA</span><br></pre></td></tr></table></figure>

<p>Besides <code>.text</code>, <code>.data</code> and <code>.bss</code>, we get four other sections here, the read-only data <code>.rodata</code>, the elf comments <code>.elf</code>, the stack note <code>.note.GUN-Stack</code> and DWARF-based unwinding <code>.eh_frame</code>. The latter four are less important so we don’t discuss them. </p>
<p>Before going deep, let us first understand the important attributes of a section. Size and File offset are quite easy to understand. The ‘CONTENTS’, ‘ALLOC’ in the second line of each section are also attributes of sections. “CONTENTS” mean the section exist in files. We can see ‘.bss’ does not have “CONTENTS”, which means it does not have any content in the ELF file. ‘.note.GNU-stack’ exists but the size is 0. So only <code>.text</code>, <code>.data</code>, <code>.rodata</code> and <code>.eh_frame</code> “truly” exist in the file. </p>
<p>Command <code>size</code> can be used to check the total size of code, data, and BSS sections (dec is the decimal value of the sum of the three sections).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ size test.o</span><br><span class="line">   text    data     bss     dec     hex filename</span><br><span class="line">    179       8       4     191      bf test.o</span><br></pre></td></tr></table></figure>

<h3 id="Code-Section"><a href="#Code-Section" class="headerlink" title="Code Section"></a>Code Section</h3><p>We use <code>objdump</code> here again to get what code exist. <code>&#39;-s&#39;</code> will print out all section data in hex and <code>&#39;-d&#39;</code> will disassemble of all the code content. Irrelevant parts are ignored.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -s -d test.o</span><br><span class="line">...</span><br><span class="line">Contents of section .text:</span><br><span class="line"> 0000 554889e5 4883ec10 897dfc8b 45fc89c6  UH..H....&#125;..E...</span><br><span class="line"> 0010 488d3d00 000000b8 00000000 e8000000  H.=.............</span><br><span class="line"> 0020 0090c9c3 554889e5 4883ec10 c745f801  ....UH..H....E..</span><br><span class="line"> 0030 0000008b 15000000 008b0500 00000001  ................</span><br><span class="line"> 0040 c28b45f8 01c28b45 fc01d089 c7e80000  ..E....E........</span><br><span class="line"> 0050 00008b45 f8c9c3                      ...E...         </span><br><span class="line">...</span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;func1&gt;:</span><br><span class="line">   0:   55                      push   %rbp</span><br><span class="line">   1:   48 89 e5                mov    %rsp,%rbp</span><br><span class="line">   4:   48 83 ec 10             sub    <span class="variable">$0x10</span>,%rsp</span><br><span class="line">   8:   89 7d <span class="built_in">fc</span>                mov    %edi,-0x4(%rbp)</span><br><span class="line">   b:   8b 45 <span class="built_in">fc</span>                mov    -0x4(%rbp),%eax</span><br><span class="line">   e:   89 c6                   mov    %eax,%esi</span><br><span class="line">  10:   48 8d 3d 00 00 00 00    lea    0x0(%rip),%rdi        <span class="comment"># 17 &lt;func1+0x17&gt;</span></span><br><span class="line">  17:   b8 00 00 00 00          mov    <span class="variable">$0x0</span>,%eax</span><br><span class="line">  1c:   e8 00 00 00 00          callq  21 &lt;func1+0x21&gt;</span><br><span class="line">  21:   90                      nop</span><br><span class="line">  22:   c9                      leaveq </span><br><span class="line">  23:   c3                      retq   </span><br><span class="line"></span><br><span class="line">0000000000000024 &lt;main&gt;:</span><br><span class="line">  24:   55                      push   %rbp</span><br><span class="line">  25:   48 89 e5                mov    %rsp,%rbp</span><br><span class="line">  28:   48 83 ec 10             sub    <span class="variable">$0x10</span>,%rsp</span><br><span class="line">  2c:   c7 45 f8 01 00 00 00    movl   <span class="variable">$0x1</span>,-0x8(%rbp)</span><br><span class="line">  33:   8b 15 00 00 00 00       mov    0x0(%rip),%edx        <span class="comment"># 39 &lt;main+0x15&gt;</span></span><br><span class="line">  39:   8b 05 00 00 00 00       mov    0x0(%rip),%eax        <span class="comment"># 3f &lt;main+0x1b&gt;</span></span><br><span class="line">  3f:   01 c2                   add    %eax,%edx</span><br><span class="line">  41:   8b 45 f8                mov    -0x8(%rbp),%eax</span><br><span class="line">  44:   01 c2                   add    %eax,%edx</span><br><span class="line">  46:   8b 45 <span class="built_in">fc</span>                mov    -0x4(%rbp),%eax</span><br><span class="line">  49:   01 d0                   add    %edx,%eax</span><br><span class="line">  4b:   89 c7                   mov    %eax,%edi</span><br><span class="line">  4d:   e8 00 00 00 00          callq  52 &lt;main+0x2e&gt;</span><br><span class="line">  52:   8b 45 f8                mov    -0x8(%rbp),%eax</span><br><span class="line">  55:   c9                      leaveq </span><br><span class="line">  56:   c3                      retq</span><br></pre></td></tr></table></figure>

<p>The first column is the offset. We can see the size of the code is 0x57, same as the value in the section. Comparing with the disassembled code, we can see the functions <code>main</code> and <code>func1</code> are the same as we defined in the code. </p>
<h3 id="Data-and-Read-only-data-Section"><a href="#Data-and-Read-only-data-Section" class="headerlink" title="Data and Read-only data Section"></a>Data and Read-only data Section</h3><p><code>&#39;.data&#39;</code> section saves <code>initialized</code> <strong>global variable and local static variable</strong>. In the example, we have ‘global_init_var’ and ‘static_init_var’, each with size 4, the total size is 8, which is the same as the section size. The value is the same as we assigned in the code, 1 and 85 in big-endian.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  1 .data         00000008  0000000000000000  0000000000000000  00000098  2**2</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, DATA</span><br><span class="line">...</span><br><span class="line">Contents of section .data:</span><br><span class="line"> 0000 01000000 55000000                    ....U... <span class="comment"># The first column is the offset.</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><code>&#39;.rodata&#39;</code> contains read-only data which are string or ‘const’ decorated variables. In the test.c, when we call printf, we use a string with value <code>&quot;%d\n&quot;</code>, it’s read-only so it is put into <code>.rodata</code>. We can see the section size is 4, which is the same as the string’s ASCII stream terminated with ‘\n’. In some embedded systems, this section can be put into read-only storage, like ROM, to guarantee the mutability. Interesting to mention here is sometimes some compiler will put the string into ‘.data’ instead of ‘.rodata’.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  3 .rodata       00000004  0000000000000000  0000000000000000  000000a0  2**0</span><br><span class="line">                  CONTENTS, ALLOC, LOAD, READONLY, DATA</span><br><span class="line">...</span><br><span class="line">Contents of section .rodata:</span><br><span class="line"> 0000 25640a00                             %d..</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="BSS-Section"><a href="#BSS-Section" class="headerlink" title="BSS Section"></a>BSS Section</h3><p><code>&#39;.bss&#39;</code> section contains <code>uninitialized</code> <strong>global variable and local static variable</strong>. In test.c global_uninit_var and static_uninit_var are located in BBS section, more correct statement is the BSS section reserves space for them. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2 .bss          00000004  0000000000000000  0000000000000000  000000a0  2**2</span><br><span class="line">                ALLOC</span><br></pre></td></tr></table></figure>

<p>But why the size is only 4, different from our definition of 8? From the Symbol Table (which will be discussed below), <code>we can see only static_uninit_var is reserved by BSS section</code>. global_uninit_var does not exist in any section, what we can only find is a <a href="todo">‘COMMON symbol’</a>. In this case, the global uninitialized variable is assigned space during link-time when executable is built. </p>
<p><strong>oops!</strong></p>
<p>Where will a and b be assigned?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> b = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p>‘a’ will be assigned in ‘.bss’ and ‘b’ will be assigned in ‘.data’ section. Because the value of a is 0, same as uninitialized variable, compiler will put it in bss section to reduce the file size.</p>
<h3 id="Custom-Section"><a href="#Custom-Section" class="headerlink" title="Custom Section"></a>Custom Section</h3><p>Sometimes we want to put certain data together or map them to different hardware, custom sections can be used. <code>__attribute__((section(&quot;name&quot;)))</code> is used to put certain variable or function into the section with “name”.</p>
<h2 id="ELF-file-structure"><a href="#ELF-file-structure" class="headerlink" title="ELF file structure"></a>ELF file structure</h2><p>From the above example, we have some idea how the ELF file looks like. The actual ELF is more complex.</p>
<table>
<thead>
<tr>
<th>ELF File Content</th>
</tr>
</thead>
<tbody><tr>
<td>ELF Header</td>
</tr>
<tr>
<td>.text</td>
</tr>
<tr>
<td>.data</td>
</tr>
<tr>
<td>.bss</td>
</tr>
<tr>
<td>…other sections</td>
</tr>
<tr>
<td>Section header table</td>
</tr>
<tr>
<td>String tables<br>Symbol tables</td>
</tr>
</tbody></table>
<p><code>&#39;objdump -h&#39;</code> can be used to check sections, but it only lists the important sections in the file. <code>readelf</code> can be used to list the actual section list stored in ‘Section header table’.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -S test.o</span><br><span class="line"></span><br><span class="line">There are 13 section headers, starting at offset 0x450:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type             Address           Offset</span><br><span class="line">       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  [ 0]                   NULL             0000000000000000  00000000</span><br><span class="line">       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">  [ 1] .text             PROGBITS         0000000000000000  00000040</span><br><span class="line">       0000000000000057  0000000000000000  AX       0     0     1</span><br><span class="line">  [ 2] .rela.text        RELA             0000000000000000  00000340</span><br><span class="line">       0000000000000078  0000000000000018   I      10     1     8</span><br><span class="line">  [ 3] .data             PROGBITS         0000000000000000  00000098</span><br><span class="line">       0000000000000008  0000000000000000  WA       0     0     4</span><br><span class="line">  [ 4] .bss              NOBITS           0000000000000000  000000a0</span><br><span class="line">       0000000000000004  0000000000000000  WA       0     0     4</span><br><span class="line">  [ 5] .rodata           PROGBITS         0000000000000000  000000a0</span><br><span class="line">       0000000000000004  0000000000000000   A       0     0     1</span><br><span class="line">  [ 6] .comment          PROGBITS         0000000000000000  000000a4</span><br><span class="line">       000000000000002a  0000000000000001  MS       0     0     1</span><br><span class="line">  [ 7] .note.GNU-stack   PROGBITS         0000000000000000  000000ce</span><br><span class="line">       0000000000000000  0000000000000000           0     0     1</span><br><span class="line">  [ 8] .eh_frame         PROGBITS         0000000000000000  000000d0</span><br><span class="line">       0000000000000058  0000000000000000   A       0     0     8</span><br><span class="line">  [ 9] .rela.eh_frame    RELA             0000000000000000  000003b8</span><br><span class="line">       0000000000000030  0000000000000018   I      10     8     8</span><br><span class="line">  [10] .symtab           SYMTAB           0000000000000000  00000128</span><br><span class="line">       0000000000000198  0000000000000018          11    11     8</span><br><span class="line">  [11] .strtab           STRTAB           0000000000000000  000002c0</span><br><span class="line">       000000000000007e  0000000000000000           0     0     1</span><br><span class="line">  [12] .shstrtab         STRTAB           0000000000000000  000003e8</span><br><span class="line">       0000000000000061  0000000000000000           0     0     1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  l (large), p (processor specific)</span><br></pre></td></tr></table></figure>

<h3 id="Relocation-Table"><a href="#Relocation-Table" class="headerlink" title="Relocation Table"></a>Relocation Table</h3><p>We can find the ‘.rela.text’ in the sections above, which is our relocation table. When the linker is processing the target files, it will do relocation of the code in ‘.text’ or data in ‘.data’. In the example, printf is the code that references to an absolute address. Our example does not have such variable in data section, so we cannot find ‘.rela.data’.</p>
<h3 id="String-Table-and-Short-String-Table-strtab-amp-shstrtab"><a href="#String-Table-and-Short-String-Table-strtab-amp-shstrtab" class="headerlink" title="String Table and Short String Table (.strtab &amp; .shstrtab)"></a>String Table and Short String Table (.strtab &amp; .shstrtab)</h3><p>ELF file is using quite many strings, like section name, variable name. The string table holds such strings to support ELF parsing.</p>
<h3 id="Symbol-Table-symtab-Interface-for-the-linker"><a href="#Symbol-Table-symtab-Interface-for-the-linker" class="headerlink" title="Symbol Table (.symtab) - Interface for the linker"></a>Symbol Table (.symtab) - Interface for the linker</h3><p>The linking process is similar to making LEGO building blocks, assemble pieces of code into one. The target files must have tenon to hook to each other. The tenons are actually the references between modules. If module B wants to use the function ‘foo’ in module A, we call A <strong>defines</strong> ‘foo’, and B <strong>reference</strong> to ‘foo’ in A. It also applies to variables. In the link process, we call function and variable as <strong>Symbol</strong>, the variable name and function name as <strong>Symbol name</strong>.</p>
<p>Each file has a Symbol Table which contains all symbols used in current file. Each symbol has a symbol value, which is the address of the symbol. </p>
<p>Symbols can be:</p>
<ol>
<li>Global symbol defined in the current file, they can be referenced by another file. For example, ‘main’, ‘func1’, ‘global_init_var’ in test.c.</li>
<li>Global symbol referenced by the current file but not defined in the current file. We call them ‘External Symbol’. For example, ‘printf’ in test.c.</li>
<li>Section name generated by the compiler. The value is the start address of the section. Examples are ‘.data’ and ‘.text’.</li>
<li>Local Symbol like ‘static_init_var’, ‘static_uninit_var’. They are only visible inside the file itself and is ignored by the linker.</li>
<li>Line number which is optional. </li>
</ol>
<p>We can use <code>readelf -s</code> to check the symbol table.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">readelf -s test.o</span><br><span class="line"></span><br><span class="line">Symbol table <span class="string">'.symtab'</span> contains 17 entries:</span><br><span class="line">   Num:    Value          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND </span><br><span class="line">     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS test.c</span><br><span class="line">     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    1 </span><br><span class="line">     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    3 </span><br><span class="line">     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    4 </span><br><span class="line">     5: 0000000000000000     0 SECTION LOCAL  DEFAULT    5 </span><br><span class="line">     6: 0000000000000004     4 OBJECT  LOCAL  DEFAULT    3 static_init_var.1802</span><br><span class="line">     7: 0000000000000000     4 OBJECT  LOCAL  DEFAULT    4 static_uninit_var.1803</span><br><span class="line">     8: 0000000000000000     0 SECTION LOCAL  DEFAULT    7 </span><br><span class="line">     9: 0000000000000000     0 SECTION LOCAL  DEFAULT    8 </span><br><span class="line">    10: 0000000000000000     0 SECTION LOCAL  DEFAULT    6 </span><br><span class="line">    11: 0000000000000000     4 OBJECT  GLOBAL DEFAULT    3 global_init_var</span><br><span class="line">    12: 0000000000000004     4 OBJECT  GLOBAL DEFAULT  COM global_uninit_var</span><br><span class="line">    13: 0000000000000000    36 FUNC    GLOBAL DEFAULT    1 func1</span><br><span class="line">    14: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND _GLOBAL_OFFSET_TABLE_</span><br><span class="line">    15: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND <span class="built_in">printf</span></span><br><span class="line">    16: 0000000000000024    51 FUNC    GLOBAL DEFAULT    1 main</span><br></pre></td></tr></table></figure>

<p>Ndx is the section contains the symbol.</p>
<ol>
<li><strong>main</strong> is in ‘.text’ which is 1. </li>
<li><strong>printf</strong> is referenced but not defined. So its Ndx is UND.</li>
<li><strong>global_init_var</strong> is initialized global variable in BSS whose Ndx is 3.</li>
<li><strong>global_uninit_var</strong> is uninitialized global variable. It’s a ‘COMMON’ symbol which does not exist in BSS.</li>
<li><strong>static_init_var</strong> and <strong>static_uninit_var</strong> are static variables whose name is changed by the name decoration process (which is also called name mangling).</li>
</ol>
<h4 id="Name-Decoration"><a href="#Name-Decoration" class="headerlink" title="Name Decoration"></a>Name Decoration</h4><p>A decorated name is an encoded string created by the compiler during the compilation of an object, data, or function definition. It records calling conventions, types, function parameters, and other information together with the name. This name decoration, also known as name mangling, helps the linker find the correct functions and objects when linking an executable.</p>
<p>More information can be found <a href="https://docs.microsoft.com/en-us/cpp/build/reference/decorated-names?view=vs-2019#:~:text=Functions%2C%20data%2C%20and%20objects%20in,%2C%20data%2C%20or%20function%20definition." target="_blank" rel="noopener">here</a>.</p>
<h4 id="Strong-Symbol-and-Weak-Symbol"><a href="#Strong-Symbol-and-Weak-Symbol" class="headerlink" title="Strong Symbol and Weak Symbol"></a>Strong Symbol and Weak Symbol</h4><p>Sometimes we can see multiple definition error. If we define variable var in both file A and B and initialize it in both files, we will get this kind of error. ‘var’ here is a strong symbol. For C/C++, the linker treat function and initialized global variable as strong symbols and uninitialized global variable as weak symbols. We can also use ‘<strong>attribute</strong>((weak))’ to make a strong symbol into a weak one. Based on the symbol type, the linker will create global symbol table based on following rules.</p>
<ol>
<li><strong>Rule 1</strong> Multiple strong symbols are not allowed.</li>
<li><strong>Rule 2</strong> When both strong and weak symbols exist, choose the strong symbol.</li>
<li><strong>Rule 3</strong> When all symbols are weak symbols, choose the one with the biggest size.</li>
</ol>
<p>Weak/Strong symbols are different from Weak/Strong references. When the linker deals with weak reference, if the symbol is not found, the linker will not raise errors and will treat this symbol as NULL or a special value the code can recognize. We can use ‘<strong>attribute</strong>((weakref))’ to declare a weak reference to the external symbol. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((weakref)) <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    foo();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The code can compile but will fail because the code is executing NULL pointer. We can use following code to avoid segmentation fault.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((weakref)) <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(foo) foo();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Weak symbols and week references are quite useful for libraries. For example, the weak symbols defined in the library can be replaced by the strong symbols defined in the application. In this case, the application can use a customized library function. The application can also define some functions in the library as a week reference, to make part of the library optional modules.</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>The page today talks about target files, the next step is how the linker will combine them to make a bigger module or application. We will discuss them later.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://book.douban.com/subject/3652388/" target="_blank" rel="noopener">程序员的自我修养</a></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/05/24/nextcloud-stuck-in-the-login-page/" rel="prev" title="nextcloud keeps cycling in the login page when reverse proxy is used">
      <i class="fa fa-chevron-left"></i> nextcloud keeps cycling in the login page when reverse proxy is used
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/06/01/Static-Linking/" rel="next" title="Static Linking">
      Static Linking <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Study-with-test-o"><span class="nav-number">1.</span> <span class="nav-text">Study with test.o</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Code-Section"><span class="nav-number">1.1.</span> <span class="nav-text">Code Section</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Data-and-Read-only-data-Section"><span class="nav-number">1.2.</span> <span class="nav-text">Data and Read-only data Section</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BSS-Section"><span class="nav-number">1.3.</span> <span class="nav-text">BSS Section</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Custom-Section"><span class="nav-number">1.4.</span> <span class="nav-text">Custom Section</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ELF-file-structure"><span class="nav-number">2.</span> <span class="nav-text">ELF file structure</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Relocation-Table"><span class="nav-number">2.1.</span> <span class="nav-text">Relocation Table</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#String-Table-and-Short-String-Table-strtab-amp-shstrtab"><span class="nav-number">2.2.</span> <span class="nav-text">String Table and Short String Table (.strtab &amp; .shstrtab)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Symbol-Table-symtab-Interface-for-the-linker"><span class="nav-number">2.3.</span> <span class="nav-text">Symbol Table (.symtab) - Interface for the linker</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Name-Decoration"><span class="nav-number">2.3.1.</span> <span class="nav-text">Name Decoration</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Strong-Symbol-and-Weak-Symbol"><span class="nav-number">2.3.2.</span> <span class="nav-text">Strong Symbol and Weak Symbol</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Summary"><span class="nav-number">3.</span> <span class="nav-text">Summary</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-number">4.</span> <span class="nav-text">Reference</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Bo Han</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hanbo1990" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hanbo1990" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hanbo1990@gmail.com" title="E-Mail → mailto:hanbo1990@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/hanbo1990/" title="LinkedIn → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;hanbo1990&#x2F;" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i>LinkedIn</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Bo Han</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  

</body>
</html>
